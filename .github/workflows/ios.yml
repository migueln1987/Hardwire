name: KMP/CMP iOS Build
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test KMP iOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17' # CMP usually requires Java 17+
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build KMP Shared Framework
        run: ./gradlew :shared:linkReleaseFrameworkIosSimulatorArm64

      - name: Set Default Scheme
        run: |
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          echo "SCHEME=$default" >> $GITHUB_ENV
          echo "Using default scheme: $default"

      - name: Build & Test
        env:
          PLATFORM: 'iOS Simulator'
        run: |
          # Find the first available iPhone simulator
          DEVICE=$(xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | sed -e "s/ Simulator$//" | xargs)
          
          # Detect workspace or project
          if [ -d *.xcworkspace ]; then
            FILE_TYPE="workspace"
            FILE_NAME=$(ls -d *.xcworkspace | head -1)
          else
            FILE_TYPE="project"
            FILE_NAME=$(ls -d *.xcodeproj | head -1)
          fi

          # Build and Test
          xcodebuild test \
            -scheme "$SCHEME" \
            -"$FILE_TYPE" "$FILE_NAME" \
            -destination "platform=$PLATFORM,name=$DEVICE" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
