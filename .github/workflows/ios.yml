name: KMP/CMP iOS IPA Build
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Create iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # 1. Build the Kotlin shared framework
      # If your folder is not 'composeApp', change ':composeApp' below to your module name
      - name: Build KMP Shared Framework
        run: ./gradlew :composeApp:linkReleaseFrameworkIosArm64

      # 2. Detect Project and Scheme Names
      - name: Set Environment Variables
        run: |
          SCHEME=$(xcodebuild -list -json | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
          if [ -d *.xcworkspace ]; then
            echo "FILE_TYPE=workspace" >> $GITHUB_ENV
            echo "FILE_NAME=$(ls -d *.xcworkspace | head -1)" >> $GITHUB_ENV
          else
            echo "FILE_TYPE=project" >> $GITHUB_ENV
            echo "FILE_NAME=$(ls -d *.xcodeproj | head -1)" >> $GITHUB_ENV
          fi

      # 3. Create the Archive (Unsigned)
      - name: Archive Build
        run: |
          xcodebuild archive \
            -$FILE_TYPE "$FILE_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath $PWD/build/Runner.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY=""

      # 4. Convert Archive to IPA for Sideloading
      - name: Export IPA
        run: |
          mkdir -p $PWD/build/Payload
          cp -r $PWD/build/Runner.xcarchive/Products/Applications/*.app $PWD/build/Payload/
          cd build
          zip -r ios-app.ipa Payload
          
      # 5. Upload the IPA as a downloadable artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-build
          path: build/ios-app.ipa
          retention-days: 7
H
