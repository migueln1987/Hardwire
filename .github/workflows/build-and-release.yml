name: Build and Release (Android & iOS)

on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch:

jobs:
  build:
    name: Build Multiplatform App
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Android APK
        run: ./gradlew :composeApp:assembleDebug

      - name: Build KMP Shared Framework
        run: ./gradlew :composeApp:linkReleaseFrameworkIosArm64

      - name: Detect iOS Project Info
        working-directory: ./iosApp
        run: |
          # 1. Capture JSON to file
          xcodebuild -list -json > project_info.json

          # 2. Use Python to safely parse despite hidden BOM/Encoding issues
          python3 << 'EOF'
          import json
          import os
          import sys

          try:
              with open("project_info.json", "rb") as f:
                  # decode with utf-8-sig to strip potential Byte Order Marks
                  raw = f.read().decode("utf-8-sig", errors="ignore")
              
              # Find the actual start of the JSON object
              start = raw.find("{")
              if start == -1:
                  raise ValueError("No valid JSON found in xcodebuild output")
              
              data = json.loads(raw[start:])
              scheme = data['project']['targets'][0]
              
              with open(os.environ['GITHUB_ENV'], 'a') as env:
                  env.write(f"SCHEME={scheme}\n")
              print(f"Detected SCHEME: {scheme}")
          except Exception as e:
              print(f"Logic Error: {e}")
              sys.exit(1)
          EOF

          # 3. Detect Project vs Workspace
          if [ -d *.xcworkspace ]; then
            echo "F_TYPE=workspace" >> $GITHUB_ENV
            echo "F_NAME=$(ls -d *.xcworkspace | head -1)" >> $GITHUB_ENV
          else
            echo "F_TYPE=project" >> $GITHUB_ENV
            echo "F_NAME=$(ls -d *.xcodeproj | head -1)" >> $GITHUB_ENV
          fi

      - name: Archive iOS
        working-directory: ./iosApp
        run: |
          xcodebuild archive \
            -$F_TYPE "$F_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath $PWD/../build/Runner.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY=""

      - name: Package Assets
        run: |
          APP_NAME="Hardwire"
          VERSION=${GITHUB_REF_NAME:-"manual"}
          
          mkdir -p $PWD/build/Payload
          cp -r $PWD/build/Runner.xcarchive/Products/Applications/*.app $PWD/build/Payload/
          cd build
          zip -r "${APP_NAME}-${VERSION}.ipa" Payload
          cd ..
          
          APK_PATH=$(find composeApp/build/outputs/apk/debug -name "*.apk" | head -1)
          cp "$APK_PATH" "build/${APP_NAME}-${VERSION}.apk"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/*.apk,build/*.ipa"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: |
            ## New Build Ready for Testing
            
            ### Android
            - Download the `.apk` file below.
            
            ### iOS
            - Download the `.ipa` file below. (Sideloading required)

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            build/*.ipa
            build/*.apk
