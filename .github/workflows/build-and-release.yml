name: Build and Release (Android & iOS)

on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch:

jobs:
  build:
    name: Build Multiplatform App
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Android APK
        run: ./gradlew :composeApp:assembleDebug

      - name: Build KMP Shared Framework
        run: ./gradlew :composeApp:linkReleaseFrameworkIosArm64

      - name: Detect iOS Project Info
        working-directory: ./iosApp
        run: |
          # Filter xcodebuild output to only include lines between the first '{' and the last '}'
          RAW_JSON=$(xcodebuild -list -json)
          CLEAN_JSON=$(echo "$RAW_JSON" | sed -n '/{/,/}/p')
          
          # Now parse the cleaned JSON
          SCHEME=$(echo "$CLEAN_JSON" | ruby -e "require 'json'; puts JSON.parse(STDIN.read)['project']['targets'][0]")
          
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
          [ -d *.xcworkspace ] && echo "F_TYPE=workspace" >> $GITHUB_ENV || echo "F_TYPE=project" >> $GITHUB_ENV
          [ -d *.xcworkspace ] && echo "F_NAME=$(ls -d *.xcworkspace | head -1)" >> $GITHUB_ENV || echo "F_NAME=$(ls -d *.xcodeproj | head -1)" >> $GITHUB_ENV

      - name: Archive iOS
        working-directory: ./iosApp
        run: |
          xcodebuild archive \
            -$F_TYPE "$F_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath $PWD/../build/Runner.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY=""

      - name: Package Assets
        run: |
          APP_NAME="Hardwire"
          # Use tag name if available, otherwise use 'manual'
          VERSION=${GITHUB_REF_NAME:-"manual"}
          
          # Prepare iOS IPA (wrapping the .app in a Payload folder)
          mkdir -p $PWD/build/Payload
          cp -r $PWD/build/Runner.xcarchive/Products/Applications/*.app $PWD/build/Payload/
          cd build
          zip -r "${APP_NAME}-${VERSION}.ipa" Payload
          cd ..
          
          # Prepare Android APK (copy and rename for the release)
          cp composeApp/build/outputs/apk/debug/*.apk "build/${APP_NAME}-${VERSION}.apk"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/*.apk,build/*.ipa"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: |
            ## New Build Ready for Testing
            
            ### Android
            1. Download the `.apk` file below.
            2. Install directly on your device.
            
            ### iOS
            1. Download the `.ipa` file below.
            2. Use **Sideloadly** or **AltStore** to install on your iPhone.
            3. Remember to "Trust" the app in Settings > General > VPN & Device Management.

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: build/*.ipa
